<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>途八哥旅行网</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
	<style>
		body{
			font-family: Microsoft YaHei;
			background-color: #f9f9f9;
		}
		p{
			-webkit-margin-before: 0px;
    		-webkit-margin-after: 0px;
		}
		nav{
			padding: 0px 15px;
		}
		#wrapper{
			position: relative;
		}
		.footer{
			position: absolute;
			bottom: 0px;
		}
		.navbar-static-top{
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
		}
		#content-area{
			position: relative;
			border-width: 0px;
			padding-bottom: 60px;
			background: url(/img/background.jpg) fixed;
		}
		#tbg-toolbar{
			background-color: white;
			box-shadow: #d3d3d3 0px 24px 59px;
			width: 100px;
			padding: 10px;
			position: fixed;
			left: 50px;
			top: 90px;
		}
		.toolbar-item{
			margin: 10px;
			cursor: pointer;
		}
		.toolbar-divider{
			min-height: 10px;
		}
		#tbg-toolbar .fa{
			font-size: 35px;
		    display: block;
		}
		.toolbar-title{
			width: 100%;
			text-align: center;
		}
		.toolbar-icon{
			width: 100%;
			text-align: center;
			color: #39c6cd;
		}
		#article-area{
			max-width: 800px;
			display: block;
			margin-top: 90px;
			background-color: white;
			border-width: 0px;
			min-height: 600px;
			box-shadow: 0px 24px 59px #b2c0bf;
			padding: 0px;
		}
		#article-content{
			min-height: 600px;
			padding: 20px;
		}
		#title-area{
			position: fixed;
			top: 150px;
			right: 25px;
			width: 22%;
			padding: 10px;
			background: white;
			box-shadow: 0px 24px 59px #b2c0bf;
		}
		#uploadCoverBtn{
			display: block;
			margin: 0px auto;
		}
		#coverImgPreview{
			max-width: 100%;
			margin: 0px auto;
			display: block;
		}
		.toolbar-button{
			margin: 5px;
			font-size: 16px;
		}
		.article-item{
			position: relative;
			margin: 10px;
			padding: 5px;
		}
		.article-item-toolbar{
			position: absolute;
			right: 0px;
			top: 2px;
			display: none;
		}
		.article-item:hover{
			border: 1px dotted green;
		}
		.article-item:hover .article-item-toolbar{
			display: block;
		}
		#newImg{
			cursor: pointer;
			max-width: 400px;
			display: block;
			margin: 0px auto;
		}
		#coverImgPreview{
			cursor: pointer;
		}
		#newImageText{
			margin-top: 20px;
		}
		.tbg-article-img-text{
			text-align: center;
		}
		.tbg-article-img{
			max-width: 100%;
			display: block;
			margin: 0px auto;
		}
		#tbg-header-toolbar{
			position: fixed;
			top: 90px;
			right: 25px;
		}
		.tbg-p-title{
			border-left-width: 5px;
    		border-left-style: solid;
    		padding-left: 10px;
		    font-size: 1.1em;
		    font-weight: bolder;
		    margin-top: 20px;
		}
		.tbg-p-title:nth-child(7n+1){
			border-left-color: #0a9dc7;
			color: #0a9dc7;
		}
		.tbg-p-title:nth-child(7n+2){
			border-left-color: #ad5f00;
			color: #ad5f00;
		}
		.tbg-p-title:nth-child(7n+3){
			border-left-color: #adad00;
			color: #adad00;
		}
		.tbg-p-title:nth-child(7n+4){
			border-left-color: #00ad00;
			color: #00ad00;
		}
		.tbg-p-title:nth-child(7n+5){
			border-left-color: #adad00;
			color: #adad00;
		}
		.tbg-p-title:nth-child(7n+6){
			border-left-color: #ad5f00;
			color: #ad5f00;
		}
		.tbg-p-title:nth-child(7n+7){
			border-left-color: #ad0000;
			color: #ad0000;
		}
		.tbg-p-tip{
			border: 1px solid #1ab394;
		    padding: 20px;
		    margin-top: 20px;
		}
		.article-item-content{
			word-break: break-all;
		}
	</style>
</head>

<body class="top-navigation">
    <div id="wrapper">
      <div style="overflow: hidden;">
        <div id="header-area" class="row border-bottom">
        </div>
        <div id="content-area" class="row">
			<div id="tbg-header-toolbar">
				<button id="tbgSaveBtn" class="btn btn-primary btn-lg  pull-right" type="button"><i class="fa fa-save"></i></button>
			</div>
        	<div class="row">
        		<div class="col-xs-2"></div>
	        	<div id="article-area" class="col-xs-7">
	        		<div id="article-content" class="sortable droppable">
	        			<div class="article-item tbg-p-image" data-type="image">
	        				<div class="article-item-content" data-type="image">
	        					<img src="/img/instruction.png" class="tbg-article-img">
	        					<p class="tbg-article-img-text"></p>
	        				</div>
	        				<span class="article-item-toolbar">
	        					<a class="toolbar-button" href="#" data-action="edit" title="编辑"><i class="fa fa-pencil"></i></a>
	        					<a class="toolbar-button" href="#" data-action="delete" title="删除"><i class="fa fa-trash-o"></i></a>
	        				</span>
	        			</div>
	        		</div>
	        	</div>
        		<div class="col-xs-3">
        			<div id="title-area">
        				<input id="article-title-input" type="text" class="form-control" placeholder="游记标题" />
        				<div style="margin-top: 20px;">
        					<img id="coverImgPreview" src="/img/default.png" />
        				</div>
        				<div style="margin-top: 20px;">
        					<input type="file" id="coverinputfile" style="height:0;width:0;z-index: -1;"/>
        				</div>
        			</div>
        		</div>
        	</div>
        	<div id="tbg-toolbar">
        		<div class="toolbar-item draggable" data-type="title">
        			<p class="toolbar-icon" data-type="title">
        				<i class="fa fa-list-ul"></i>
        			</p>
        			<p class="toolbar-title" data-type="title">段落标题</p>
        		</div>
        		<div class="toolbar-divider">
        		</div>
        		<div class="toolbar-item draggable" data-type="text">
        			<p class="toolbar-icon" data-type="text">
        				<i class="fa fa-align-justify"></i>
        			</p>
        			<p class="toolbar-title" data-type="text">文字</p>
        		</div>
        		<div class="toolbar-divider">
        		</div>
        		<div class="toolbar-item draggable" data-type="image">
        			<p class="toolbar-icon" data-type="image">
        				<i class="fa fa-picture-o"></i>
        			</p>
        			<p class="toolbar-title" data-type="image">照片</p>
        		</div>
        		<div class="toolbar-divider">
        		</div>
        		<div class="toolbar-item draggable" data-type="tip">
        			<p class="toolbar-icon" data-type="tip">
        				<i class="fa fa-info"></i>
        			</p>
        			<p class="toolbar-title" data-type="tip">小贴士</p>
        		</div>
        	</div>
        </div>
        <div class="modal inmodal fade" id="titleModal" tabindex="-1" role="dialog"  aria-hidden="true">
           <div class="modal-dialog modal-lg">
               <div class="modal-content">
                   <div class="modal-header">
                       <h2 class="modal-title">段落标题</h2>
                   </div>
                   <div class="modal-body">
                       <input id="newTitleText" type="text" class="form-control" placeholder="段落标题" />
                   </div>

                   <div class="modal-footer">
                       <button type="button" class="btn btn-white" id="newTitleCancelBtn" data-dismiss="modal">取消</button>
                       <button type="button" class="btn btn-primary" id="newTitleBtn">确定</button>
                   </div>
               </div>
           </div>
       </div>
       <div class="modal inmodal fade" id="textModal" tabindex="-1" role="dialog"  aria-hidden="true">
           <div class="modal-dialog modal-lg">
               <div class="modal-content">
                   <div class="modal-header">
                       <h2 class="modal-title">文字段落</h2>
                   </div>
                   <div class="modal-body">
                       <textarea id="newTextArea" rows="10" class="form-control" placeholder="书写故事..." ></textarea>
                   </div>

                   <div class="modal-footer">
                       <button type="button" class="btn btn-white" id="newTextCancelBtn" data-dismiss="modal">取消</button>
                       <button type="button" class="btn btn-primary" id="newTextBtn">确定</button>
                   </div>
               </div>
           </div>
       </div>
       <div class="modal inmodal fade" id="tipModal" tabindex="-1" role="dialog"  aria-hidden="true">
           <div class="modal-dialog modal-lg">
               <div class="modal-content">
                   <div class="modal-header">
                       <h2 class="modal-title">旅行小贴士</h2>
                   </div>
                   <div class="modal-body">
                       <textarea id="newTipArea" rows="10" class="form-control" placeholder="温馨提示" ></textarea>
                   </div>

                   <div class="modal-footer">
                       <button type="button" class="btn btn-white" id="newTipCancelBtn" data-dismiss="modal">取消</button>
                       <button type="button" class="btn btn-primary" id="newTipBtn">确定</button>
                   </div>
               </div>
           </div>
       </div>
       <div class="modal inmodal fade" id="imageModal" tabindex="-1" role="dialog"  aria-hidden="true">
           <div class="modal-dialog modal-lg">
               <div class="modal-content">
                   <div class="modal-header">
                       <h2 class="modal-title">图片</h2>
                   </div>
                   <div class="modal-body">
                   		<label style="margin-bottom:10px;"></label>
                   		<img id="newImg" src="/img/default.png "/>
                   		<input id="newImageText" class="form-control" placeholder="给我一个描述" ></input>
                   		<input type="file" id="imageinputfile" style="height:0;width:0;z-index: -1;"/>
                   </div>

                   <div class="modal-footer">
                       <button type="button" class="btn btn-white" id="newImageCancelBtn" data-dismiss="modal">取消</button>
                       <button type="button" class="btn btn-primary" id="newImageBtn">确定</button>
                   </div>
               </div>
           </div>
       </div>
    </div>
   </div>



    <!-- Mainly scripts -->
    <script src="/js/jquery-2.1.1.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script src="/js/tbg/header.js"></script>
	<script src="/js/tbg/utility.js"></script>
	
	<script>
		$("#coverImgPreview").click(function(){
			document.getElementById('coverinputfile').click();
			
			$("#coverinputfile").change(function(){
				var data = new FormData();
				data.append('file', $('#coverinputfile')[0].files[0]);
				$.ajax({
					url:'/upload/image',
					type:'POST',
					data:data,
					cache: false,
					contentType: false,
					processData: false,
					success:function(d){
						var img = document.getElementById("coverImgPreview");
						img.src = "/resource/file/" + d;
					},
					error:function(){
						console.log("upload failed");
					}
				});
			});
		});
		
		$("#newImg").click(function(){
			document.getElementById('imageinputfile').click();
			
			$("#imageinputfile").change(function(){
				var data = new FormData();
				data.append('file', $('#imageinputfile')[0].files[0]);
				$.ajax({
					url:'/upload/image',
					type:'POST',
					data:data,
					cache: false,
					contentType: false,
					processData: false,
					success:function(d){
						var img = document.getElementById("newImg");
						img.src = "/resource/file/" + d;
					},
					error:function(){
						console.log("upload failed");
					}
				});
			});
		});
		
		$(document).ready(function(){
			var articleUuid = tbgUtil.getUrlParam("articleid");
			var article = null;
			if(articleUuid){
				$.ajax({
		            url:'/account/article/'+articleUuid,
		            contentType:"application/json;charset=UTF-8"
		        }).done(function(data){
		        	article = data;
		        	document.getElementById("article-title-input").value = article.title;
					document.getElementById("coverImgPreview").src = article.coverImg;
					var items = article.items;
					if(!items){
						return;
					}
					items.map(function(item){
						var root = document.getElementById("article-content");
						var node = document.createElement("div");
						node.classList.add("article-item");
						node.dataset["type"] = item.type;
						var content = document.createElement("div");
						content.classList.add("article-item-content");
						content.dataset["type"] = item.type;
						node.appendChild(content);
						switch(item.type){
							case "title":
								node.classList.add("tbg-p-title");
								content.textContent = item.text;
								break;
							case "text":
								node.classList.add("tbg-p-text");
								content.textContent = item.text;
								break;
							case "tip":
								node.classList.add("tbg-p-tip");
								content.textContent = item.text;
								break;
							case "image":
								node.classList.add("tbg-p-image");
								var img = document.createElement("img");
								img.classList.add("tbg-article-img");
								img.src = item.src;
								content.appendChild(img);
								var p = document.createElement("p");
								p.classList.add("tbg-article-img-text");
								p.textContent = item.text;
								content.appendChild(p);
								break;
						}
						node.appendChild(createToolbar());
						root.appendChild(node);
					});
		        });
			}
			
			$( "#tbg-toolbar .draggable" ).draggable({
	    		opacity: 0.7,
	    		connectWith: ".droppable",
	    		connectToSortable: ".droppable",
	    		zIndex:100000,
	    		cursor: "move",
	    		helper: function() {
	    			var type = this.dataset["type"];
		            var img = $(this).clone();
		            var div = $('<div class="article-item" data-type="'+type+'"></div>').append(img);
		            return $(div);
		        }
			});
			$( ".sortable" ).sortable({
	    		opacity: 0.7,
	    		connectWith: ".droppable",
	    		receive: onDrop
			});
			$(".toolbar-item").click(function(evt){
				var ele = evt.target;
				while(!ele.classList.contains("toolbar-item")){
					ele = ele.parentNode;
				}
				var type = ele.dataset["type"];
				var node = document.createElement("div");
				node.classList.add("article-item");
				node.dataset["type"] = type;
				node.textContent = "";
				document.getElementById("article-content").appendChild(node);
				addItem(type, node);
			});
			
			function onDrop(evt){
		    	var ele = evt.toElement;
				while(!ele.classList.contains("article-item")){
					ele = ele.parentNode;
				}
				ele.innerHTML = "";
				ele.removeAttribute("style");
		    	var type = ele.dataset["type"];
		    	addItem(type, ele);
			}
			
			function addItem(type, node){
				switch(type){
		    		case "text":
		    			showText(node,"", "new");
		    			break;
		    		case "title":
		    			showTitle(node,"", "new");
		    			break;
		    		case "image":
		    			showImage(node,"/img/default.png","", "new");
		    			break;
		    		case "tip":
		    			showTip(node,"", "new");
		    			break;
		    	}
			}
			
			function editItem(node){
				var type = node.dataset["type"];
				switch(type){
		    		case "text":
		    			var text = node.firstElementChild.textContent;
		    			showText(node,text, "edit");
		    			break;
		    		case "title":
		    			var title = node.firstElementChild.textContent;
		    			showTitle(node,title, "edit");
		    			break;
		    		case "image":
		    			var img = node.firstElementChild.firstElementChild;
		    			var p = img.nextSibling;
		    			showImage(node, img.getAttribute("src"), p.textContent, "edit");
		    			break;
		    		case "tip":
		    			var tip = node.firstElementChild.textContent;
		    			showTip(node,tip, "edit");
		    			break;
		    	}
			}
			
			function showTitle(node,val, mode){
				$("#newTitleText").val(val);
				$("#titleModal").modal("show");
				$("#titleModal").data("node", node);
				$("#titleModal").data("mode", mode);
			}
			
			function showText(node,val, mode){
				$("#newTextArea").val(val);
				$("#textModal").modal("show");
				$("#textModal").data("node", node);
				$("#textModal").data("mode", mode);
			}
			
			function showTip(node,val, mode){
				$("#newTipArea").val(val);
				$("#tipModal").modal("show");
				$("#tipModal").data("node", node);
				$("#tipModal").data("mode", mode);
			}
			
			function showImage(node,src,val, mode){
				$("#newImg").attr("src", src);
				$("#newImageText").val(val);
				$("#imageModal").modal("show");
				$("#imageModal").data("node", node);
				$("#imageModal").data("mode", mode);
			}
			
			function createToolbar(){
				var bar = document.createElement("span");
				bar.classList.add("article-item-toolbar");
				bar.innerHTML = '<a class="toolbar-button" href="#" data-action="edit" title="编辑"><i class="fa fa-pencil"></i></a>' +
								'<a class="toolbar-button" href="#" data-action="delete" title="删除"><i class="fa fa-trash-o"></i></a>';
				return bar;
			}
			
			$("#newTitleBtn").click(function(){
				var node = $("#titleModal").data("node");
				var mode = $("#titleModal").data("mode");
				var title = $("#newTitleText").val();
				if(mode == "new"){
					node.innerHTML = "";
					var content = document.createElement("div");
					content.textContent = title;
					content.classList.add("article-item-content");
					content.dataset["type"] = "title";
					node.appendChild(content);
					node.appendChild(createToolbar());
					node.classList.add("tbg-p-title");
				}
				else{
					node.firstElementChild.textContent = title;
				}
				$("#titleModal").modal("hide");
			});
			$("#newTitleCancelBtn").click(function(){
				var node = $("#titleModal").data("node");
				var mode = $("#titleModal").data("mode");
				if(mode == "new"){
					node.parentNode.removeChild(node);
				}
			});
			
			$("#newTextBtn").click(function(){
				var node = $("#textModal").data("node");
				var mode = $("#textModal").data("mode");
				var title = $("#newTextArea").val();
				if(mode == "new"){
					node.innerHTML = "";
					var content = document.createElement("div");
					content.textContent = title;
					content.classList.add("article-item-content");
					content.dataset["type"] = "text";
					node.appendChild(content);
					node.appendChild(createToolbar());
					node.classList.add("tbg-p-text");
				}
				else{
					node.firstElementChild.textContent = title;
				}
				$("#textModal").modal("hide");
			});
			$("#newTextCancelBtn").click(function(){
				var node = $("#textModal").data("node");
				var mode = $("#textModal").data("mode");
				if(mode == "new"){
					node.parentNode.removeChild(node);
				}
			});
			
			$("#newTipBtn").click(function(){
				var node = $("#tipModal").data("node");
				var mode = $("#tipModal").data("mode");
				var title = $("#newTipArea").val();
				if(mode == "new"){
					node.innerHTML = "";
					var content = document.createElement("div");
					content.textContent = title;
					content.classList.add("article-item-content");
					content.dataset["type"] = "tip";
					node.appendChild(content);
					node.appendChild(createToolbar());
					node.classList.add("tbg-p-tip");
				}
				else{
					node.firstElementChild.textContent = title;
				}
				$("#tipModal").modal("hide");
			});
			$("#newTipCancelBtn").click(function(){
				var node = $("#tipModal").data("node");
				var mode = $("#tipModal").data("mode");
				if(mode == "new"){
					node.parentNode.removeChild(node);
				}
			});
			
			$("#newImageBtn").click(function(){
				var node = $("#imageModal").data("node");
				var mode = $("#imageModal").data("mode");
				var title = $("#newImageText").val();
				var src = $("#newImg").attr("src");
				if(mode == "new"){
					node.innerHTML = "";
					var content = document.createElement("div");
					content.classList.add("article-item-content");
					content.dataset["type"] = "image";
					var img = document.createElement("img");
					img.setAttribute("src", src);
					img.classList.add("tbg-article-img");
					content.appendChild(img);
					var p = document.createElement("p");
					p.textContent = title;
					p.classList.add("tbg-article-img-text");
					content.appendChild(p);
					node.appendChild(content);
					node.appendChild(createToolbar());
					node.classList.add("tbg-p-image");
				}
				else{
					var img = node.firstElementChild.firstElementChild;
					img.setAttribute("src", src);
					var p = img.nextSibling;
					p.textContent = title;
				}
				$("#imageModal").modal("hide");
			});
			$("#newImageCancelBtn").click(function(){
				var node = $("#imageModal").data("node");
				var mode = $("#imageModal").data("mode");
				if(mode == "new"){
					node.parentNode.removeChild(node);
				}
			});
			
			$("#article-content").on("click", ".toolbar-button", function(evt){
				var node = evt.originalEvent.srcElement;
				while(node && node.tagName != "A"){
					node = node.parentNode;
				}
				var action = node.dataset["action"];
				while(!node.classList.contains("article-item")){
					node = node.parentNode;
				}
				if(action == "edit"){
					editItem(node);
				}
				else if(action == "delete"){
					node.parentNode.removeChild(node);
				}
			});
			
			$("#tbgSaveBtn").click(function(){
				if(articleUuid == null){
					articleUuid = "A"+tbgUtil.getUuid();
				}
				var today = tbgUtil.getToday();
				var items = [];
				var idx = 1;
				$(".article-item-content").each(function(){
					var item = {
						uuid: "P"+tbgUtil.getUuid(),
						status: "D",
						index: idx,
						bookUuid: articleUuid,
						date: today
					};
				    var type = this.dataset["type"];
				    item.type = type;
				    if(type == "image"){
				    	item.src = this.children[0].src;
				    	item.text = this.children[1].textContent;
				    }
				    else{
				    	item.text = this.textContent;
				    }
				    items.push(item);
				    idx++;
				 });
				if(article){
					article.items = items;
					article.title = document.getElementById("article-title-input").value;
					article.coverImg = document.getElementById("coverImgPreview").src;
					article.status = "D";
				}
				else{
					article = {
							uuid: articleUuid,
							title: document.getElementById("article-title-input").value,
							coverImg: document.getElementById("coverImgPreview").src,
							status: "D",
							items: items,
							dateCreated: today,
							startDate: today,
							finishDate: today
						};
				}
				console.log(article);
				saveArticle(article);
			});
			
			function saveArticle(article){
				$.ajax({
					url:'/upload/article',
					type:'POST',
					data: JSON.stringify(article),
					contentType:"application/json;charset=UTF-8",
					success:function(d){
						console.log(d);
					},
					error:function(){
						console.log("upload failed");
					}
				});
			}
		});
	</script>

</body>

</html>